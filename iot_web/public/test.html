<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test MQTT Connection</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f7fa;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .warning {
            background: #fff3e0;
            color: #ef6c00;
            border-left: 4px solid #ff9800;
        }

        .info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .log {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin: 3px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Gas Detection System - Test Panel</h1>
        <p>C√¥ng c·ª• ki·ªÉm tra k·∫øt n·ªëi v√† ch·ª©c nƒÉng h·ªá th·ªëng</p>

        <!-- Server Status -->
        <div class="test-section">
            <h3>1. Ki·ªÉm tra Server</h3>
            <div id="serverStatus" class="status info">ƒêang ki·ªÉm tra...</div>
            <button onclick="testServer()">Test l·∫°i</button>
        </div>

        <!-- WebSocket Status -->
        <div class="test-section">
            <h3>2. Ki·ªÉm tra WebSocket</h3>
            <div id="wsStatus" class="status info">Ch∆∞a k·∫øt n·ªëi</div>
            <button onclick="testWebSocket()">K·∫øt n·ªëi WebSocket</button>
            <button onclick="disconnectWS()">Ng·∫Øt k·∫øt n·ªëi</button>
        </div>

        <!-- API Tests -->
        <div class="test-section">
            <h3>3. Test API Endpoints</h3>
            <div id="apiStatus" class="status info">S·∫µn s√†ng test</div>
            <button onclick="testGetData()">GET /api/data</button>
            <button onclick="testControlRelay()">Test Control</button>
            <button onclick="testSetThreshold()">Set Threshold</button>
        </div>

        <!-- Send Test Data -->
        <div class="test-section">
            <h3>4. G·ª≠i d·ªØ li·ªáu test (m√¥ ph·ªèng ESP32)</h3>
            <div id="mqttStatus" class="status info">
                Ch·ª©c nƒÉng n√†y y√™u c·∫ßu MQTT client. S·ª≠ d·ª•ng Arduino code ƒë·ªÉ test.
            </div>
            <button onclick="simulateGasData()">M√¥ ph·ªèng Gas cao</button>
            <button onclick="simulateFireAlert()">M√¥ ph·ªèng ph√°t hi·ªán l·ª≠a</button>
        </div>

        <!-- Log -->
        <div class="test-section">
            <h3>üìã Console Log</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">X√≥a log</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        const WS_URL = 'ws://localhost:8080';
        let ws = null;

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString('vi-VN');
            const color = type === 'error' ? '#ff5252' : type === 'success' ? '#69f0ae' : '#aed581';
            logEl.innerHTML = `<div class="log-entry" style="color: ${color}">[${time}] ${message}</div>` + logEl.innerHTML;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        // Test Server
        async function testServer() {
            const statusEl = document.getElementById('serverStatus');
            statusEl.className = 'status info';
            statusEl.textContent = 'ƒêang ki·ªÉm tra server...';
            log('Testing server connection...');

            try {
                const response = await fetch(`${API_URL}/api/health`);
                const data = await response.json();

                if (data.success) {
                    statusEl.className = 'status success';
                    statusEl.innerHTML = `‚úÖ Server ƒëang ho·∫°t ƒë·ªông!<br>
                        MQTT: ${data.mqtt ? '‚úÖ Connected' : '‚ùå Disconnected'}<br>
                        WebSocket Clients: ${data.websocket}<br>
                        Uptime: ${Math.round(data.uptime)}s`;
                    log('Server is running correctly', 'success');
                } else {
                    throw new Error('Server response failed');
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. ƒê·∫£m b·∫£o server ƒëang ch·∫°y t·∫°i port 3000';
                log('Server connection failed: ' + error.message, 'error');
            }
        }

        // Test WebSocket
        function testWebSocket() {
            const statusEl = document.getElementById('wsStatus');
            log('Connecting to WebSocket...');

            try {
                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    statusEl.className = 'status success';
                    statusEl.textContent = '‚úÖ WebSocket ƒë√£ k·∫øt n·ªëi th√†nh c√¥ng!';
                    log('WebSocket connected successfully', 'success');
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    log(`WS Message: ${JSON.stringify(data)}`);
                };

                ws.onerror = (error) => {
                    statusEl.className = 'status error';
                    statusEl.textContent = '‚ùå L·ªói WebSocket';
                    log('WebSocket error: ' + error, 'error');
                };

                ws.onclose = () => {
                    statusEl.className = 'status warning';
                    statusEl.textContent = '‚ö†Ô∏è WebSocket ƒë√£ ng·∫Øt k·∫øt n·ªëi';
                    log('WebSocket disconnected', 'info');
                };
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi WebSocket';
                log('WebSocket connection failed: ' + error.message, 'error');
            }
        }

        function disconnectWS() {
            if (ws) {
                ws.close();
                log('WebSocket disconnected by user');
            }
        }

        // Test API - Get Data
        async function testGetData() {
            const statusEl = document.getElementById('apiStatus');
            log('Testing GET /api/data...');

            try {
                const response = await fetch(`${API_URL}/api/data`);
                const data = await response.json();

                statusEl.className = 'status success';
                statusEl.innerHTML = `‚úÖ API Response:<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                log('GET /api/data successful', 'success');
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå API Error: ' + error.message;
                log('API test failed: ' + error.message, 'error');
            }
        }

        // Test Control
        async function testControlRelay() {
            log('Testing control API...');

            try {
                const response = await fetch(`${API_URL}/api/control/relay1`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ state: true })
                });
                const data = await response.json();

                log(`Control test successful: ${JSON.stringify(data)}`, 'success');
                alert('‚úÖ Control API ho·∫°t ƒë·ªông! Check MQTT ƒë·ªÉ xem message.');
            } catch (error) {
                log('Control test failed: ' + error.message, 'error');
                alert('‚ùå Control API error: ' + error.message);
            }
        }

        // Test Set Threshold
        async function testSetThreshold() {
            log('Testing set threshold API...');

            try {
                const response = await fetch(`${API_URL}/api/control/threshold`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threshold: 3500 })
                });
                const data = await response.json();

                log(`Threshold set successful: ${JSON.stringify(data)}`, 'success');
                alert('‚úÖ Threshold API ho·∫°t ƒë·ªông!');
            } catch (error) {
                log('Threshold test failed: ' + error.message, 'error');
            }
        }

        // Simulate functions
        function simulateGasData() {
            alert('üí° ƒê·ªÉ m√¥ ph·ªèng d·ªØ li·ªáu gas:\n\n1. S·ª≠ d·ª•ng MQTT client (nh∆∞ MQTT Explorer)\n2. Publish v√†o topic: gas/sensor/mq2\n3. Payload: 5000 (ho·∫∑c gi√° tr·ªã cao)');
            log('Simulation guide shown');
        }

        function simulateFireAlert() {
            alert('üí° ƒê·ªÉ m√¥ ph·ªèng c·∫£nh b√°o l·ª≠a:\n\n1. S·ª≠ d·ª•ng MQTT client\n2. Publish v√†o topic: gas/sensor/fire\n3. Payload: 0 (0 = ph√°t hi·ªán l·ª≠a)');
            log('Fire simulation guide shown');
        }

        // Auto-run tests on load
        window.onload = () => {
            log('Test panel loaded', 'success');
            testServer();
        };
    </script>
</body>

</html>